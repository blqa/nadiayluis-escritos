<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nadia & Luis | Mis Escritos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { serif: ['"Playfair Display"', 'serif'], sans: ['"Inter"', 'sans-serif'] },
                    colors: { romantic: { dark: '#2D1B2E', pink: '#F7CAD0', rose: '#E11D48' } },
                    animation: { 'float': 'float 8s ease-in-out infinite', 'fade-in-up': 'fadeInUp 0.8s ease-out forwards', 'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both' },
                    keyframes: { 
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        fadeInUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #FAFAFA; color: #2D1B2E; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .noise-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; opacity: 0.03; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.3); }
        .glass-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); transition: all 0.3s ease; cursor: pointer; }
        .glass-card:hover { transform: translateY(-3px); background: rgba(255, 255, 255, 0.98); box-shadow: 0 15px 30px -5px rgba(0,0,0,0.05); border-color: rgba(225, 29, 72, 0.1); }
        
        .dropcap::first-letter {
            float: left;
            font-size: 3.5rem;
            line-height: 0.8;
            font-weight: 700;
            margin-right: 0.1em;
            color: #E11D48;
            font-family: "Playfair Display", serif;
        }

        /* Modal Styles */
        dialog { 
            background: transparent; 
            border: none; 
            padding: 0; 
            width: 100%; 
            height: 100%; 
            max-width: none; 
            max-height: none;
            backdrop-filter: blur(5px);
        }
        dialog::backdrop { background: rgba(0,0,0,0.4); }
        
        /* Custom Input Styles for Editor */
        .editor-input {
            width: 100%;
            background-color: #FAFAFA;
            border: 1px solid #E5E7EB;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            transition: all 0.2s;
        }
        .editor-input:focus {
            outline: none;
            border-color: #F43F5E;
            box-shadow: 0 0 0 3px rgba(244, 63, 94, 0.1);
            background-color: white;
        }

        /* Rich Text Editor Styles */
        #rich-editor {
            min-height: 250px;
            max-height: 400px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #E5E7EB;
            border-radius: 0 0 0.75rem 0.75rem;
            padding: 1rem;
            font-family: 'Inter', sans-serif;
            color: #374151;
        }
        #rich-editor:focus {
            outline: none;
            border-color: #F43F5E;
            box-shadow: 0 0 0 3px rgba(244, 63, 94, 0.1);
        }
        .toolbar-btn {
            padding: 0.4rem;
            border-radius: 0.375rem;
            color: #4B5563;
            transition: all 0.2s;
        }
        .toolbar-btn:hover { background-color: #FEE2E2; color: #E11D48; }
        .toolbar-btn.active { background-color: #FECDD3; color: #BE123C; }

        /* Filter Styles */
        .filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s;
            border: 1px solid transparent;
            color: #6B7280;
        }
        .filter-btn:hover { color: #E11D48; background: #FFF1F2; }
        .filter-btn.active { background: #E11D48; color: white; box-shadow: 0 4px 6px -1px rgba(225, 29, 72, 0.2); }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <div class="noise-bg"></div>
    <canvas id="particleCanvas" class="fixed top-0 left-0 w-full h-full -z-10 opacity-30"></canvas>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-[60] bg-rose-600 text-white px-6 py-3 rounded-full shadow-xl text-sm font-medium transform transition-all duration-300 -translate-y-20 opacity-0 flex items-center gap-2">
        <i data-lucide="alert-circle" class="w-4 h-4"></i>
        <span id="toast-msg">Mensaje</span>
    </div>

    <!-- NAVBAR -->
    <nav class="fixed top-0 left-0 w-full z-50 glass-nav h-16 flex items-center justify-between px-6 md:px-12">
        <a href="index.html" class="opacity-50 hover:opacity-100 transition-opacity flex items-center gap-2 text-xs uppercase tracking-widest text-gray-500">
            <i data-lucide="arrow-left" class="w-4 h-4"></i> Volver al Inicio
        </a>
        <span class="font-serif italic text-xl text-gray-800">L <span class="text-rose-400">&</span> N</span>
        <div class="w-20"></div>
    </nav>

    <!-- HEADER -->
    <header class="pt-32 pb-8 px-6 text-center relative overflow-hidden">
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[600px] h-[400px] bg-rose-100/40 rounded-full blur-[80px] -z-10"></div>
        <div class="max-w-2xl mx-auto space-y-4 animate-fade-in-up">
            <div class="inline-block p-3 rounded-full bg-white/50 mb-4 shadow-sm">
                <i data-lucide="feather" class="w-6 h-6 text-rose-400"></i>
            </div>
            <h1 class="font-serif text-5xl md:text-7xl text-gray-900 leading-tight">
                Bit√°cora del <br/><span class="italic text-rose-500">Coraz√≥n</span>
            </h1>
            <p class="text-gray-500 font-light text-sm md:text-base tracking-wide max-w-md mx-auto">
                Todo lo que no puedo callar, todo lo que te escribo en silencio.
            </p>
        </div>
    </header>

    <!-- FILTER BAR (SIMPLIFICADO) -->
    <section class="px-4 pb-8 sticky top-16 z-40 bg-white/5 backdrop-blur-sm transition-all duration-300">
        <div class="max-w-5xl mx-auto flex flex-wrap justify-center gap-2 md:gap-4 overflow-x-auto py-2">
            <button onclick="applyFilter('all')" class="filter-btn active" id="filter-all">Todo</button>
            
            <div class="w-px h-6 bg-gray-200 mx-2 self-center"></div>
            
            <!-- Tag Filters (Icons) -->
            <button onclick="applyFilter('heart')" class="filter-btn" id="filter-heart" title="Coraz√≥n"><i data-lucide="heart" class="w-3 h-3"></i></button>
            <button onclick="applyFilter('feather')" class="filter-btn" id="filter-feather" title="Poes√≠a"><i data-lucide="feather" class="w-3 h-3"></i></button>
            <button onclick="applyFilter('moon')" class="filter-btn" id="filter-moon" title="Sue√±os"><i data-lucide="moon" class="w-3 h-3"></i></button>
            <button onclick="applyFilter('star')" class="filter-btn" id="filter-star" title="Especial"><i data-lucide="star" class="w-3 h-3"></i></button>
            <button onclick="applyFilter('music')" class="filter-btn" id="filter-music" title="M√∫sica"><i data-lucide="music" class="w-3 h-3"></i></button>
            <button onclick="applyFilter('coffee')" class="filter-btn" id="filter-coffee" title="Caf√©"><i data-lucide="coffee" class="w-3 h-3"></i></button>
        </div>
    </section>

    <!-- WRITINGS GRID -->
    <main class="flex-grow px-4 pb-24">
        <div class="max-w-5xl mx-auto">
            <div id="writings-container" class="columns-1 md:columns-2 gap-6 space-y-6">
                <!-- Loading State -->
                <div class="glass-card p-8 rounded-2xl text-center">
                    <p class="text-gray-400 animate-pulse">Conectando con el coraz√≥n...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- SECRET BUTTON -->
    <button id="secret-btn" class="fixed bottom-6 right-6 z-50 p-4 bg-white/80 backdrop-blur-md shadow-lg rounded-full text-rose-400 hover:text-rose-600 hover:bg-white transition-all duration-300 transform hover:scale-110 border border-rose-100" title="Nuevo Escrito">
        <i data-lucide="pen-tool" class="w-6 h-6"></i>
    </button>

    <footer class="py-8 text-center text-gray-400 text-[10px] md:text-xs uppercase tracking-widest bg-white/50 backdrop-blur-sm relative group">
        <p class="opacity-50">escritos.nadiayluis.art</p>
    </footer>

    <!-- ADD WRITING MODAL -->
    <dialog id="writing-modal">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="glass-card w-full max-w-2xl bg-white p-8 rounded-3xl shadow-2xl relative animate-fade-in-up border-rose-100 overflow-hidden">
                <button id="close-modal" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors z-20">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                
                <!-- === VISTA DE LOGIN === -->
                <div id="auth-view" class="py-10 text-center">
                    <h3 class="font-serif text-3xl text-gray-800 mb-2">Identif√≠cate</h3>
                    <p class="text-gray-400 text-sm mb-10">Para proteger nuestros secretos.</p>

                    <!-- User Selection -->
                    <div id="user-select" class="flex justify-center gap-6 mb-8">
                        <button onclick="selectUser('luis')" class="group flex flex-col items-center gap-3 p-4 rounded-2xl hover:bg-blue-50 transition-all border border-transparent hover:border-blue-100">
                            <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-3xl group-hover:scale-110 transition-transform">ü§¥üèª</div>
                            <span class="font-serif text-gray-600 group-hover:text-blue-600">Soy Luis</span>
                        </button>
                        <button onclick="selectUser('nadia')" class="group flex flex-col items-center gap-3 p-4 rounded-2xl hover:bg-rose-50 transition-all border border-transparent hover:border-rose-100">
                            <div class="w-16 h-16 rounded-full bg-rose-100 flex items-center justify-center text-3xl group-hover:scale-110 transition-transform">üë∏üèª</div>
                            <span class="font-serif text-gray-600 group-hover:text-rose-600">Soy Nadia</span>
                        </button>
                    </div>

                    <!-- Auth Forms (Hidden initially) -->
                    <div id="auth-forms" class="hidden max-w-xs mx-auto">
                        <!-- Luis Form -->
                        <div id="luis-form" class="hidden space-y-4">
                            <p class="text-xs uppercase tracking-widest text-blue-400 font-bold mb-2">Contrase√±a Maestra</p>
                            <input type="password" id="luis-pass" placeholder="Ingresa la clave..." class="editor-input text-center">
                            <button onclick="verifyLuis()" class="w-full bg-blue-500 text-white font-bold py-2 rounded-xl hover:bg-blue-600 transition-colors">Entrar</button>
                        </div>
                        
                        <!-- Nadia Form -->
                        <div id="nadia-form" class="hidden space-y-4">
                            <p class="text-xs uppercase tracking-widest text-rose-400 font-bold mb-2">Pregunta de Seguridad</p>
                            <label class="block text-sm text-gray-600 mb-2">¬øCon qu√© coraz√≥n te tengo agregada en WhatsApp?</label>
                            <input type="text" id="nadia-answer" placeholder="Pista: es hueco..." class="editor-input text-center">
                            <button onclick="verifyNadia()" class="w-full bg-rose-500 text-white font-bold py-2 rounded-xl hover:bg-rose-600 transition-colors">Entrar</button>
                        </div>
                        
                        <button onclick="resetAuth()" class="mt-4 text-xs text-gray-400 hover:text-gray-600 underline">Cambiar usuario</button>
                    </div>
                </div>
                
                <!-- === VISTA DE EDITOR === -->
                <div id="editor-view" class="hidden">
                    <div class="mb-6 flex items-center gap-3">
                        <div class="bg-rose-100 p-2 rounded-lg">
                            <i data-lucide="pen-tool" class="w-6 h-6 text-rose-500"></i>
                        </div>
                        <div>
                            <h3 class="font-serif text-2xl text-gray-800" id="editor-title-text">Nuevo Recuerdo</h3>
                            <p class="text-xs text-gray-400 uppercase tracking-wide">Escribiendo como <span id="current-author" class="font-bold text-rose-500">...</span></p>
                        </div>
                    </div>
                    
                    <form id="writing-form" class="space-y-6">
                        <input type="hidden" id="edit-id" value=""> <!-- ID para editar -->
                        
                        <!-- T√≠tulo -->
                        <div>
                            <input type="text" id="w-title" required placeholder="T√≠tulo del momento..." class="w-full bg-transparent border-b border-gray-200 p-2 font-serif text-2xl focus:outline-none focus:border-rose-400 placeholder-gray-300 transition-colors">
                        </div>
                        
                        <!-- RICH TEXT EDITOR -->
                        <div>
                            <!-- Toolbar -->
                            <div class="flex flex-wrap gap-2 mb-0 bg-gray-50 border border-gray-200 border-b-0 rounded-t-xl p-2 items-center">
                                <button type="button" onclick="execCmd('bold')" class="toolbar-btn" title="Negrita"><i data-lucide="bold" class="w-4 h-4"></i></button>
                                <button type="button" onclick="execCmd('italic')" class="toolbar-btn" title="Cursiva"><i data-lucide="italic" class="w-4 h-4"></i></button>
                                <button type="button" onclick="execCmd('underline')" class="toolbar-btn" title="Subrayado"><i data-lucide="underline" class="w-4 h-4"></i></button>
                                <div class="w-px h-4 bg-gray-300 mx-1"></div>
                                
                                <!-- Color Picker Wrapper -->
                                <div class="relative group cursor-pointer">
                                    <div class="toolbar-btn flex items-center gap-1"><i data-lucide="palette" class="w-4 h-4"></i></div>
                                    <input type="color" onchange="execCmd('foreColor', this.value)" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full" title="Color de texto">
                                </div>

                                <!-- Font Size -->
                                <select onchange="execCmd('fontSize', this.value)" class="bg-transparent text-xs text-gray-600 border border-gray-200 rounded p-1 focus:outline-none">
                                    <option value="3">Normal</option>
                                    <option value="1">Peque√±o</option>
                                    <option value="5">Grande</option>
                                    <option value="7">Enorme</option>
                                </select>
                            </div>
                            
                            <!-- Editable Area -->
                            <div id="rich-editor" contenteditable="true" class="focus:outline-none"></div>
                        </div>

                        <!-- Fechas y Detalles -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-50 p-4 rounded-xl">
                            <!-- Fecha Escrito -->
                            <div>
                                <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-1 font-semibold">Escrito el</label>
                                <input type="date" id="w-date-written" required class="bg-white border border-gray-200 rounded p-2 w-full text-sm">
                            </div>

                            <!-- Fecha Publicaci√≥n -->
                            <div>
                                <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-1 font-semibold">Publicar</label>
                                <input type="datetime-local" id="w-date-published" class="bg-white border border-gray-200 rounded p-2 w-full text-sm">
                            </div>

                            <!-- Icono -->
                            <div>
                                <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-1 font-semibold">Icono</label>
                                <select id="w-icon" class="bg-white border border-gray-200 rounded p-2 w-full text-sm">
                                    <option value="heart">Coraz√≥n ‚ù§Ô∏è</option>
                                    <option value="feather">Poes√≠a ‚úíÔ∏è</option>
                                    <option value="moon">Sue√±os üåô</option>
                                    <option value="star">Especial ‚≠ê</option>
                                    <option value="music">Canci√≥n üéµ</option>
                                    <option value="coffee">Caf√© ‚òï</option>
                                </select>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="pt-2 flex items-center justify-end gap-3">
                            <button type="submit" class="bg-gray-900 text-white font-bold py-3 px-8 rounded-xl hover:bg-gray-800 transition-all shadow-lg flex items-center gap-2 transform hover:scale-105">
                                <i data-lucide="send" class="w-4 h-4"></i> Publicar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </dialog>

    <!-- READER MODAL (FOR VIEWING) -->
    <dialog id="reader-modal">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="glass-card w-full max-w-3xl bg-white p-8 md:p-12 rounded-3xl shadow-2xl relative animate-fade-in-up border-rose-100 max-h-[90vh] overflow-y-auto">
                <button onclick="document.getElementById('reader-modal').close()" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors z-20">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                
                <div id="reader-content" class="prose prose-rose max-w-none">
                    <!-- Content injected via JS -->
                </div>
            </div>
        </div>
    </dialog>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Vaciamos el array de datos est√°ticos
        const STATIC_WRITINGS = [];

        const firebaseConfig = {
            apiKey: "AIzaSyD0lX3XmVPQHNNxpsZS82YzDMzM6MLhq3g",
            authDomain: "godsplan-blqa.firebaseapp.com",
            projectId: "godsplan-blqa",
            storageBucket: "godsplan-blqa.firebasestorage.app",
            messagingSenderId: "1008783768310",
            appId: "1:1008783768310:web:c09fe541a2f4d23e5b8ad7",
            measurementId: "G-924H3FVC6Z"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global State
        window.currentUserType = null; // 'Luis' or 'Nadia'
        window.isAdmin = false; // Only true if Luis logs in via lock
        window.allWritingsData = []; // Store raw data for filtering
        window.activeFilter = 'all'; // Simplified filter state

        // UI Helpers
        window.showToast = (msg, isError = false) => {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-msg');
            toastMsg.innerText = msg;
            toast.classList.remove('bg-rose-600', 'bg-green-600', '-translate-y-20', 'opacity-0');
            toast.classList.add(isError ? 'bg-rose-600' : 'bg-green-600');
            setTimeout(() => { toast.classList.add('-translate-y-20', 'opacity-0'); }, 4000);
        }

        // --- FILTER LOGIC (SIMPLIFICADA) ---
        window.applyFilter = (filterValue) => {
            window.activeFilter = filterValue;
            
            // Update UI Buttons
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Highlight active button
            const activeBtn = document.getElementById(`filter-${filterValue}`);
            if(activeBtn) activeBtn.classList.add('active');

            // Filter Data
            const filtered = window.allWritingsData.filter(item => {
                if (filterValue === 'all') return true;
                return item.icon === filterValue;
            });

            renderWritings(filtered);
        }

        // --- AUTH LOGIC ---
        window.selectUser = (user) => {
            document.getElementById('user-select').classList.add('hidden');
            document.getElementById('auth-forms').classList.remove('hidden');
            if(user === 'luis') {
                document.getElementById('luis-form').classList.remove('hidden');
                setTimeout(() => document.getElementById('luis-pass').focus(), 100);
            } else {
                document.getElementById('nadia-form').classList.remove('hidden');
                setTimeout(() => document.getElementById('nadia-answer').focus(), 100);
            }
        }

        window.resetAuth = () => {
            document.getElementById('auth-forms').classList.add('hidden');
            document.getElementById('luis-form').classList.add('hidden');
            document.getElementById('nadia-form').classList.add('hidden');
            document.getElementById('luis-pass').value = '';
            document.getElementById('nadia-answer').value = '';
            document.getElementById('user-select').classList.remove('hidden');
        }

        window.verifyLuis = () => {
            const pass = document.getElementById('luis-pass').value;
            if(pass === 'godsplan') {
                window.isAdmin = true; // Enable Admin Mode
                showToast('Modo Admin Activado üîß');
                launchEditor('Luis');
                // Re-render to show admin buttons
                renderWritings(window.allWritingsData); 
            } else {
                showToast('Contrase√±a incorrecta üö´', true);
                shakeModal();
            }
        }

        window.verifyNadia = () => {
            const ans = document.getElementById('nadia-answer').value.trim();
            if(ans === '‚ô°' || ans === '‚ù§Ô∏è' || ans.toLowerCase() === 'corazon blanco') { 
                if(ans === '‚ô°') {
                     launchEditor('Nadia');
                } else {
                     showToast('Cerca... busca el coraz√≥n correcto (‚ô°)', true);
                     shakeModal();
                }
            } else {
                showToast('Respuesta incorrecta üíî', true);
                shakeModal();
            }
        }

        function launchEditor(authorName) {
            window.currentUserType = authorName;
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('editor-view').classList.remove('hidden');
            document.getElementById('current-author').innerText = authorName;
            
            // Set defaults for new post
            document.getElementById('edit-id').value = ''; // Ensure no ID
            document.getElementById('editor-title-text').innerText = "Nuevo Recuerdo";
            document.getElementById('w-title').value = '';
            document.getElementById('rich-editor').innerHTML = '';
            document.getElementById('w-date-written').valueAsDate = new Date();
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('w-date-published').value = now.toISOString().slice(0,16);
            
            lucide.createIcons();
        }

        function shakeModal() {
            const card = document.querySelector('.glass-card');
            card.classList.add('animate-shake');
            setTimeout(() => card.classList.remove('animate-shake'), 500);
        }

        // --- EDITOR LOGIC ---
        window.execCmd = (command, value = null) => {
            document.execCommand(command, false, value);
        }

        // Firebase Setup
        signInAnonymously(auth).then(() => {
            initRealtimeListener();
        }).catch((e) => {
            console.error(e);
            renderWritings(STATIC_WRITINGS);
        });

        function initRealtimeListener() {
            const q = query(collection(db, 'escritos'), orderBy('writtenDate', 'desc'));
            onSnapshot(q, (snapshot) => {
                const writings = [];
                snapshot.forEach((doc) => writings.push({ id: doc.id, ...doc.data() }));
                
                const normalizedWritings = writings.map(w => ({
                    ...w, writtenDate: w.writtenDate || w.date
                }));

                window.allWritingsData = normalizedWritings;
                
                // Re-apply current filter
                applyFilter(window.activeFilter);
            }, (error) => {
                console.error("DB Error:", error);
                renderWritings(STATIC_WRITINGS);
            });
        }

        // --- ADMIN FUNCTIONS ---
        window.deletePost = async (e, id) => {
            e.stopPropagation(); // Prevent opening reader
            if(!confirm("¬øEst√°s seguro de que quieres borrar este recuerdo para siempre?")) return;
            
            try {
                await deleteDoc(doc(db, "escritos", id));
                showToast("Escrito eliminado");
            } catch (err) {
                console.error(err);
                showToast("Error al eliminar", true);
            }
        }

        window.editPost = (e, id) => {
            e.stopPropagation(); // Prevent opening reader
            const post = window.allWritingsData.find(w => w.id === id);
            if(!post) return;

            // Open Modal in Edit Mode
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('editor-view').classList.remove('hidden');
            document.getElementById('writing-modal').showModal();
            
            // Fill Data
            document.getElementById('edit-id').value = id;
            document.getElementById('editor-title-text').innerText = "Editando Recuerdo";
            document.getElementById('current-author').innerText = post.author || "Luis";
            window.currentUserType = post.author || "Luis"; // Preserve original author
            
            document.getElementById('w-title').value = post.title;
            document.getElementById('rich-editor').innerHTML = post.content;
            document.getElementById('w-date-written').value = post.writtenDate;
            document.getElementById('w-date-published').value = post.publishedAt || "";
            document.getElementById('w-icon').value = post.icon || 'heart';
        }

        // --- VIEW COUNTER LOGIC ---
        window.openReader = async (id) => {
            const post = window.allWritingsData.find(w => w.id === id);
            if(!post) return;

            // Update Views in Background
            try {
                const postRef = doc(db, "escritos", id);
                updateDoc(postRef, {
                    views: increment(1)
                });
            } catch(e) { console.log("Error updating views", e); }

            // Populate and Show Reader Modal
            let dateStr = "";
            try {
                const [y, m, d] = post.writtenDate.split('-');
                const dateObj = new Date(y, m-1, d); 
                dateStr = dateObj.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
            } catch(e) { dateStr = post.writtenDate; }

            const readerHtml = `
                <div class="text-center mb-8">
                    <span class="text-xs uppercase tracking-widest text-rose-400 font-bold mb-2 block">${dateStr}</span>
                    <h1 class="font-serif text-3xl md:text-4xl text-gray-900 mb-4">${post.title}</h1>
                    <div class="w-16 h-px bg-rose-200 mx-auto"></div>
                </div>
                <div class="font-serif text-lg leading-loose text-gray-700">
                    ${post.content}
                </div>
                <div class="mt-12 text-right">
                    <p class="font-handwriting text-rose-500 text-xl" style="font-family: cursive;">- ${post.author || 'Luis'}</p>
                </div>
            `;
            
            document.getElementById('reader-content').innerHTML = readerHtml;
            document.getElementById('reader-modal').showModal();
        }

        function renderWritings(list) {
            const container = document.getElementById('writings-container');
            container.innerHTML = ''; 

            if (list.length === 0) {
                const emptyMsg = window.activeFilter === 'all' 
                    ? "Este libro est√° esperando ser escrito." 
                    : "No hay recuerdos con esta etiqueta.";

                container.innerHTML = `
                    <div class="col-span-1 md:col-span-2 glass-card p-12 rounded-2xl text-center flex flex-col items-center justify-center min-h-[300px] animate-fade-in-up border-dashed border-2 border-rose-100">
                        <div class="bg-rose-50 p-4 rounded-full mb-6">
                            <i data-lucide="feather" class="w-8 h-8 text-rose-400"></i>
                        </div>
                        <h3 class="font-serif text-2xl text-gray-800 mb-2">No se encontraron recuerdos</h3>
                        <p class="text-gray-500 mb-8 max-w-md mx-auto leading-relaxed">${emptyMsg}</p>
                        <button onclick="document.getElementById('secret-btn').click()" class="bg-white text-rose-500 border border-rose-200 hover:bg-rose-50 hover:border-rose-300 font-bold py-3 px-8 rounded-full transition-all duration-300 shadow-sm hover:shadow-md flex items-center gap-2">
                            <i data-lucide="pen-tool" class="w-4 h-4"></i> Escribir
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            list.forEach((item, index) => {
                const isPoem = item.isPoem || (item.title && item.title.includes('Micro-poema'));
                const delay = index * 0.1;
                let dateStr = "";
                const dateKey = item.writtenDate || item.date;
                if(dateKey) {
                    try {
                        const [y, m, d] = dateKey.split('-');
                        const dateObj = new Date(y, m-1, d); 
                        dateStr = dateObj.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
                    } catch(e) { dateStr = dateKey; }
                }

                const contentHtml = item.content;
                const viewCount = item.views || 0;
                
                // Admin Buttons HTML
                let adminControls = '';
                if (window.isAdmin) {
                    adminControls = `
                        <div class="absolute top-4 right-4 flex gap-2 z-10 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editPost(event, '${item.id}')" class="p-2 bg-white/90 rounded-full text-blue-500 hover:text-blue-600 shadow-sm hover:scale-110 transition-transform" title="Editar">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deletePost(event, '${item.id}')" class="p-2 bg-white/90 rounded-full text-red-500 hover:text-red-600 shadow-sm hover:scale-110 transition-transform" title="Borrar">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;
                }

                let html = '';
                if (isPoem) {
                    html = `
                    <article onclick="openReader('${item.id}')" class="glass-card p-8 rounded-2xl break-inside-avoid text-center bg-rose-50/30 animate-fade-in-up relative group hover:bg-rose-50/50 transition-colors" style="animation-delay: ${delay}s;">
                        ${adminControls}
                        <div class="mb-4">
                            <span class="text-[10px] uppercase tracking-widest text-rose-400 font-bold">${item.title}</span>
                        </div>
                        <div class="font-serif text-xl italic text-gray-800 mb-6 leading-loose line-clamp-6">
                            ${contentHtml}
                        </div>
                        <div class="flex justify-between items-end border-t border-rose-100/50 pt-4 mt-4">
                            <div class="flex items-center gap-1 text-gray-400 text-xs" title="Vistas">
                                <i data-lucide="eye" class="w-3 h-3"></i> <span>${viewCount}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-xs text-gray-400 block">${dateStr}</span>
                                <span class="text-[10px] uppercase tracking-widest text-rose-300">Por: ${item.author || 'Luis'}</span>
                            </div>
                        </div>
                    </article>`;
                } else {
                    html = `
                    <article onclick="openReader('${item.id}')" class="glass-card p-8 rounded-2xl break-inside-avoid animate-fade-in-up relative group" style="animation-delay: ${delay}s;">
                        ${adminControls}
                        <div class="flex items-center justify-between mb-6 border-b border-gray-100 pb-4">
                            <span class="text-[10px] uppercase tracking-widest text-gray-400 font-medium">${dateStr}</span>
                            <i data-lucide="${item.icon || 'feather'}" class="w-4 h-4 text-rose-300"></i>
                        </div>
                        <h2 class="font-serif text-2xl text-gray-900 mb-4 group-hover:text-rose-600 transition-colors">${item.title}</h2>
                        <div class="prose prose-p:font-serif prose-p:text-gray-600 prose-p:leading-relaxed text-sm md:text-base space-y-4 rich-text-content line-clamp-[10] mask-image-gradient">
                            ${contentHtml}
                        </div>
                        <div class="mt-6 pt-4 flex justify-between items-center">
                            <div class="flex items-center gap-1 text-gray-400 text-xs" title="Vistas">
                                <i data-lucide="eye" class="w-3 h-3"></i> <span>${viewCount}</span>
                            </div>
                            <span class="font-handwriting text-rose-400 text-lg opacity-80" style="font-family: cursive;">- ${item.author || 'Luis'}</span>
                        </div>
                    </article>`;
                }
                container.innerHTML += html;
            });
            lucide.createIcons();
        }

        // Modal Logic
        const modal = document.getElementById('writing-modal');
        const openBtn = document.getElementById('secret-btn');
        const closeBtn = document.getElementById('close-modal');

        openBtn.addEventListener('click', () => {
            // Reset to Auth View on open
            document.getElementById('auth-view').classList.remove('hidden');
            document.getElementById('editor-view').classList.add('hidden');
            resetAuth();
            modal.showModal();
        });
        
        const closeModal = () => modal.close();
        closeBtn.addEventListener('click', closeModal);

        // Submit Logic (Create or Update)
        document.getElementById('writing-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalContent = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Guardando...`;
            btn.disabled = true;

            const editId = document.getElementById('edit-id').value;
            const title = document.getElementById('w-title').value;
            const content = document.getElementById('rich-editor').innerHTML;
            const writtenDate = document.getElementById('w-date-written').value;
            const publishedAt = document.getElementById('w-date-published').value;
            const icon = document.getElementById('w-icon').value;
            
            const isPoem = (content.length < 300 && (title.toLowerCase().includes('poema')));

            const writingData = { 
                title, 
                content,
                writtenDate, 
                publishedAt, 
                icon, 
                isPoem,
                author: window.currentUserType,
                timestamp: Date.now() 
            };

            try {
                if (editId) {
                    // Update existing
                    await updateDoc(doc(db, "escritos", editId), writingData);
                    showToast("¬°Recuerdo actualizado! ‚ú®");
                } else {
                    // Create new
                    writingData.views = 0; // Init views
                    await addDoc(collection(db, 'escritos'), writingData);
                    showToast("¬°Publicado con √©xito! ‚ú®");
                }
                
                document.getElementById('writing-form').reset();
                document.getElementById('rich-editor').innerHTML = ''; 
                modal.close();
            } catch (error) {
                console.error(error);
                showToast("Error al guardar", true);
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
                lucide.createIcons();
            }
        });

        lucide.createIcons();
        
        // Particles
        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        const particleCount = window.innerWidth < 768 ? 15 : 30;
        let particles = Array.from({length: particleCount}, () => ({
            x: Math.random() * canvas.width, y: Math.random() * canvas.height,
            r: Math.random() * 2 + 0.5, d: Math.random() * Math.PI * 2, s: Math.random() * 0.2 + 0.05,
            c: ['#F7CAD0', '#C59FC9', '#A5B4FC'][Math.floor(Math.random()*3)]
        }));
        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                p.y -= p.s; p.x += Math.sin(p.d) * 0.1;
                if(p.y < -10) { p.y = canvas.height + 10; p.x = Math.random() * canvas.width; }
                ctx.fillStyle = p.c; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
            });
            requestAnimationFrame(animateParticles);
        }
        animateParticles();
    </script>
</body>
</html>
